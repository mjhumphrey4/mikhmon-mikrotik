/**
 * Mikhmon UI - Modern Dark Mode
 * Sidebar and dropdown functionality
 */

// Get DOM elements
const sidenav = document.getElementById('sidenav');
const main = document.getElementById('main');
const openNav = document.getElementById('openNav');
const closeNav = document.getElementById('closeNav');

// Toggle sidebar function
function toggleSidebar() {
  if (sidenav && main && openNav && closeNav) {
    if (sidenav.classList.contains('open')) {
      // Close sidebar
      sidenav.classList.remove('open');
      openNav.style.display = 'flex';
      closeNav.style.display = 'none';
    } else {
      // Open sidebar
      sidenav.classList.add('open');
      openNav.style.display = 'none';
      closeNav.style.display = 'flex';
    }
  }
}

// Initialize sidebar state based on screen size
function initSidebar() {
  const screenWidth = window.innerWidth;
  
  if (screenWidth > 768) {
    // Desktop: sidebar always visible
    if (sidenav) sidenav.classList.remove('open');
    if (openNav) openNav.style.display = 'none';
    if (closeNav) closeNav.style.display = 'none';
  } else {
    // Mobile: sidebar hidden by default
    if (sidenav) sidenav.classList.remove('open');
    if (openNav) openNav.style.display = 'flex';
    if (closeNav) closeNav.style.display = 'none';
  }
}

// Dropdown toggle functionality
function initDropdowns() {
  const dropdownBtns = document.getElementsByClassName('dropdown-btn');
  
  for (let i = 0; i < dropdownBtns.length; i++) {
    dropdownBtns[i].addEventListener('click', function(e) {
      e.preventDefault();
      
      // Toggle active class on button
      this.classList.toggle('active');
      
      // Toggle dropdown container
      const dropdownContent = this.nextElementSibling;
      if (dropdownContent && dropdownContent.classList.contains('dropdown-container')) {
        dropdownContent.classList.toggle('menu-open');
      }
    });
  }
}

// Auto-expand active menu items on page load
function expandActiveMenus() {
  // Find all active dropdown containers
  const activeContainers = document.querySelectorAll('.dropdown-container.menu-open');
  
  activeContainers.forEach(function(container) {
    const btn = container.previousElementSibling;
    if (btn && btn.classList.contains('dropdown-btn')) {
      btn.classList.add('active');
    }
  });
}

// Handle window resize
function handleResize() {
  const screenWidth = window.innerWidth;
  
  if (screenWidth > 768) {
    // Desktop mode
    if (sidenav) {
      sidenav.classList.remove('open');
      sidenav.style.removeProperty('width');
      sidenav.style.removeProperty('border-right');
    }
    if (main) {
      main.style.removeProperty('margin-left');
    }
    if (openNav) openNav.style.display = 'none';
    if (closeNav) closeNav.style.display = 'none';
  } else {
    // Mobile mode
    if (sidenav && !sidenav.classList.contains('open')) {
      sidenav.style.removeProperty('width');
      sidenav.style.removeProperty('border-right');
    }
    if (main) {
      main.style.removeProperty('margin-left');
    }
    if (openNav) openNav.style.display = 'flex';
    if (closeNav) closeNav.style.display = 'none';
  }
}

// Close sidebar when clicking outside on mobile
function handleClickOutside(event) {
  const screenWidth = window.innerWidth;
  
  if (screenWidth <= 768 && sidenav && sidenav.classList.contains('open')) {
    if (!sidenav.contains(event.target) && 
        !openNav.contains(event.target) && 
        !closeNav.contains(event.target)) {
      toggleSidebar();
    }
  }
}

// Initialize everything when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  initSidebar();
  initDropdowns();
  expandActiveMenus();
  
  // Add window resize listener
  window.addEventListener('resize', handleResize);
  
  // Add click outside listener
  document.addEventListener('click', handleClickOutside);
  
  // Make toggleSidebar available globally for onclick handlers
  window.toggleSidebar = toggleSidebar;
});

// Prevent dropdown links from closing the sidebar
document.addEventListener('DOMContentLoaded', function() {
  const dropdownLinks = document.querySelectorAll('.dropdown-container a');
  
  dropdownLinks.forEach(function(link) {
    link.addEventListener('click', function(e) {
      // Allow navigation but don't close sidebar on desktop
      const screenWidth = window.innerWidth;
      if (screenWidth <= 768) {
        // Close sidebar on mobile after clicking a link
        setTimeout(function() {
          if (sidenav && sidenav.classList.contains('open')) {
            toggleSidebar();
          }
        }, 100);
      }
    });
  });
});

// Smooth scroll to top when navigating
document.addEventListener('DOMContentLoaded', function() {
  const menuLinks = document.querySelectorAll('.menu, .dropdown-container a');
  
  menuLinks.forEach(function(link) {
    link.addEventListener('click', function() {
      // Scroll to top smoothly
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
  });
});

// Add loading state management
function showLoading() {
  const loading = document.getElementById('loading');
  if (loading) {
    loading.style.display = 'block';
  }
}

function hideLoading() {
  const loading = document.getElementById('loading');
  if (loading) {
    loading.style.display = 'none';
  }
}

// Make loading functions globally available
window.showLoading = showLoading;
window.hideLoading = hideLoading;

// Show loading on page navigation
document.addEventListener('DOMContentLoaded', function() {
  // Hide loading when page is ready
  hideLoading();
  
  // Show loading when clicking navigation links
  const navLinks = document.querySelectorAll('.menu, .dropdown-container a, .connect');
  
  navLinks.forEach(function(link) {
    link.addEventListener('click', function(e) {
      // Don't show loading for dropdown buttons
      if (!this.classList.contains('dropdown-btn')) {
        showLoading();
      }
    });
  });
});

// Notification system
function notify(message, duration = 3000) {
  const notifyElement = document.getElementById('notify');
  const messageElement = notifyElement.querySelector('.message');
  
  if (notifyElement && messageElement) {
    messageElement.textContent = message;
    notifyElement.style.display = 'block';
    
    // Auto-hide after duration
    setTimeout(function() {
      notifyElement.style.display = 'none';
    }, duration);
  }
}

// Make notify function globally available
window.notify = notify;

// Idle timeout functionality
let idleTimer;
let idleTime = 0;

function resetIdleTimer() {
  idleTime = 0;
}

function checkIdleTimeout() {
  const idtoElement = document.getElementById('idto');
  
  if (idtoElement && idtoElement.textContent !== 'disable') {
    const timeoutMinutes = parseInt(idtoElement.textContent);
    
    if (!isNaN(timeoutMinutes) && timeoutMinutes > 0) {
      idleTime++;
      
      // Update timer display
      const timerElement = document.getElementById('timer');
      if (timerElement) {
        const remainingMinutes = timeoutMinutes - Math.floor(idleTime / 60);
        const remainingSeconds = 60 - (idleTime % 60);
        
        if (remainingMinutes >= 0) {
          timerElement.textContent = 
            String(remainingMinutes).padStart(2, '0') + ':' + 
            String(remainingSeconds).padStart(2, '0');
        }
      }
      
      // Check if timeout reached
      if (idleTime >= timeoutMinutes * 60) {
        window.location.href = './admin.php?id=logout';
      }
    }
  }
}

// Initialize idle timeout
document.addEventListener('DOMContentLoaded', function() {
  const idtoElement = document.getElementById('idto');
  
  if (idtoElement && idtoElement.textContent !== 'disable') {
    // Reset timer on user activity
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(function(event) {
      document.addEventListener(event, resetIdleTimer, true);
    });
    
    // Check idle time every second
    idleTimer = setInterval(checkIdleTimeout, 1000);
  }
});

// Table search/filter functionality
document.addEventListener('DOMContentLoaded', function() {
  const filterInput = document.getElementById('filterTable');
  
  if (filterInput) {
    filterInput.addEventListener('keyup', function() {
      const filterValue = this.value.toLowerCase();
      const tableRows = document.querySelectorAll('#dataTable tbody tr');
      
      tableRows.forEach(function(row) {
        const text = row.textContent.toLowerCase();
        if (text.indexOf(filterValue) > -1) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
  }
});

// Make table sortable
function makeAllSortable() {
  const tables = document.querySelectorAll('table');
  
  tables.forEach(function(table) {
    const headers = table.querySelectorAll('th');
    
    headers.forEach(function(header, index) {
      header.style.cursor = 'pointer';
      header.addEventListener('click', function() {
        sortTable(table, index);
      });
    });
  });
}

function sortTable(table, columnIndex) {
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const isAscending = table.dataset.sortOrder !== 'asc';
  
  rows.sort(function(a, b) {
    const aValue = a.cells[columnIndex].textContent.trim();
    const bValue = b.cells[columnIndex].textContent.trim();
    
    // Try to parse as numbers
    const aNum = parseFloat(aValue);
    const bNum = parseFloat(bValue);
    
    if (!isNaN(aNum) && !isNaN(bNum)) {
      return isAscending ? aNum - bNum : bNum - aNum;
    }
    
    // Sort as strings
    return isAscending ? 
      aValue.localeCompare(bValue) : 
      bValue.localeCompare(aValue);
  });
  
  // Clear tbody and append sorted rows
  tbody.innerHTML = '';
  rows.forEach(function(row) {
    tbody.appendChild(row);
  });
  
  table.dataset.sortOrder = isAscending ? 'asc' : 'desc';
}

// Make sortable function globally available
window.makeAllSortable = makeAllSortable;

// Console message
console.log('%cðŸš€ Mikhmon Modern Dark UI Loaded', 'color: #0ea5e9; font-size: 16px; font-weight: bold;');
console.log('%câš¡ Optimized for performance and user experience', 'color: #10b981; font-size: 12px;');